#!/usr/bin/env python
"""
Test script to verify enhanced audio modal layout fixes
"""
import os
import sys
import django

# Add the parent directory to Python path so we can import Django modules
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Setup Django environment
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'learn_english_project.settings')
django.setup()

from django.contrib.auth import get_user_model
from vocabulary.models import Flashcard, Deck

User = get_user_model()

def create_modal_test_data():
    """Create test data for modal layout testing"""
    print("üîß Setting up test data for enhanced audio modal layout testing...")
    
    # Get or create test user
    user, created = User.objects.get_or_create(
        email='modal-layout-test@example.com',
        defaults={'is_active': True}
    )
    if created:
        user.set_password('testpass123')
        user.save()
        print(f"‚úÖ Created test user: {user.email}")
    else:
        print(f"‚úÖ Using existing test user: {user.email}")
    
    # Create test deck
    deck, created = Deck.objects.get_or_create(
        name='Enhanced Audio Modal Test Deck',
        user=user
    )
    if created:
        print(f"‚úÖ Created test deck: {deck.name}")
    else:
        print(f"‚úÖ Using existing test deck: {deck.name}")
    
    # Create test flashcards with various word lengths to test modal layout
    test_words = [
        {
            'word': 'test',
            'phonetic': '/test/',
            'part_of_speech': 'noun',
            'audio_url': 'https://dictionary.cambridge.org/media/english/us_pron/t/tes/test_/test.mp3'
        },
        {
            'word': 'pronunciation',
            'phonetic': '/pr…ôÀån ån.siÀàe…™. É…ôn/',
            'part_of_speech': 'noun',
            'audio_url': 'https://dictionary.cambridge.org/media/english/us_pron/p/pro/pronu/pronunciation.mp3'
        },
        {
            'word': 'internationalization',
            'phonetic': '/Àå…™n.t…öÀån√¶ É.…ôn.…ôl.…ôÀàze…™. É…ôn/',
            'part_of_speech': 'noun',
            'audio_url': 'https://dictionary.cambridge.org/media/english/us_pron/i/int/inter/internationalization.mp3'
        },
        {
            'word': 'modal',
            'phonetic': '/Ààmo ä.d…ôl/',
            'part_of_speech': 'adjective',
            'audio_url': 'https://dictionary.cambridge.org/media/english/us_pron/m/mod/modal/modal.mp3'
        },
        {
            'word': 'layout',
            'phonetic': '/Ààle…™.a ät/',
            'part_of_speech': 'noun',
            'audio_url': 'https://dictionary.cambridge.org/media/english/us_pron/l/lay/layou/layout.mp3'
        }
    ]
    
    created_cards = []
    for word_data in test_words:
        flashcard, created = Flashcard.objects.get_or_create(
            word=word_data['word'],
            user=user,
            deck=deck,
            defaults=word_data
        )
        created_cards.append(flashcard)
        
        if created:
            print(f"‚úÖ Created flashcard: {flashcard.word} (ID: {flashcard.id})")
        else:
            print(f"‚úÖ Using existing flashcard: {flashcard.word} (ID: {flashcard.id})")
    
    return user, deck, created_cards

def check_css_improvements():
    """Check that the CSS improvements have been applied"""
    print("\nüß™ Checking CSS improvements...")
    
    css_path = os.path.join(
        os.path.dirname(os.path.dirname(__file__)),
        'static', 'css', 'enhanced-audio-modal.css'
    )
    
    if not os.path.exists(css_path):
        print(f"‚ùå CSS file not found: {css_path}")
        return False
    
    with open(css_path, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # Check for key improvements
    improvements = {
        'flexbox_layout': 'display: flex' in content and 'flex-direction: column' in content,
        'improved_modal_size': 'max-width: 700px' in content,
        'flex_body': 'flex: 1' in content,
        'overflow_handling': 'overflow-y: auto' in content and 'overflow-x: hidden' in content,
        'button_improvements': 'min-width: 120px' in content,
        'responsive_mobile': 'width: 98%' in content,
        'content_containment': 'max-height: 300px' in content,
        'title_overflow': 'text-overflow: ellipsis' in content,
        'flex_shrink': 'flex-shrink: 0' in content
    }
    
    print("üìã CSS improvements verification:")
    print("-" * 50)
    
    for improvement, found in improvements.items():
        status = "‚úÖ PASS" if found else "‚ùå FAIL"
        print(f"{improvement}: {status}")
    
    all_improvements = all(improvements.values())
    
    if all_improvements:
        print("\n‚úÖ All CSS improvements have been applied!")
    else:
        print("\n‚ùå Some CSS improvements are missing!")
    
    return all_improvements

def print_modal_testing_guide():
    """Print comprehensive testing guide for modal layout"""
    print("\nüß™ ENHANCED AUDIO MODAL LAYOUT TESTING GUIDE")
    print("=" * 70)
    
    print("\nüéØ LAYOUT ISSUES FIXED:")
    print("-" * 40)
    print("‚úÖ Button overflow outside popup container")
    print("‚úÖ Modal sizing for different content lengths")
    print("‚úÖ Responsive design for all screen sizes")
    print("‚úÖ Button layout and alignment")
    print("‚úÖ Content containment and scrolling")
    
    print("\nüìã TESTING PROCEDURE:")
    print("-" * 40)
    
    print("\n1Ô∏è‚É£ DESKTOP LAYOUT TEST (> 1024px):")
    print("   ‚Ä¢ Navigate to: http://localhost:8000/deck/[deck_id]/")
    print("   ‚Ä¢ Click enhanced audio button (üîç) on any flashcard")
    print("   ‚Ä¢ ‚úÖ VERIFY: Modal opens with proper size (max 700px width)")
    print("   ‚Ä¢ ‚úÖ VERIFY: All buttons stay within modal boundaries")
    print("   ‚Ä¢ ‚úÖ VERIFY: Footer buttons are properly aligned")
    print("   ‚Ä¢ ‚úÖ VERIFY: Content scrolls if needed without overflow")
    print("   ‚Ä¢ ‚úÖ VERIFY: Modal title doesn't overflow with long words")
    
    print("\n2Ô∏è‚É£ TABLET LAYOUT TEST (641px - 1024px):")
    print("   ‚Ä¢ Resize browser to tablet size")
    print("   ‚Ä¢ Open enhanced audio modal")
    print("   ‚Ä¢ ‚úÖ VERIFY: Modal width adjusts to 90% of screen")
    print("   ‚Ä¢ ‚úÖ VERIFY: Buttons remain properly sized")
    print("   ‚Ä¢ ‚úÖ VERIFY: Content is fully contained")
    print("   ‚Ä¢ ‚úÖ VERIFY: Footer buttons stay in horizontal layout")
    
    print("\n3Ô∏è‚É£ MOBILE LAYOUT TEST (‚â§ 640px):")
    print("   ‚Ä¢ Resize browser to mobile size")
    print("   ‚Ä¢ Open enhanced audio modal")
    print("   ‚Ä¢ ‚úÖ VERIFY: Modal takes 98% of screen width")
    print("   ‚Ä¢ ‚úÖ VERIFY: Footer buttons stack vertically")
    print("   ‚Ä¢ ‚úÖ VERIFY: All buttons are full width on mobile")
    print("   ‚Ä¢ ‚úÖ VERIFY: Audio controls stack vertically")
    print("   ‚Ä¢ ‚úÖ VERIFY: Touch targets are adequate (44px+)")
    
    print("\n4Ô∏è‚É£ SMALL MOBILE TEST (‚â§ 480px):")
    print("   ‚Ä¢ Resize to very small mobile size")
    print("   ‚Ä¢ Open enhanced audio modal")
    print("   ‚Ä¢ ‚úÖ VERIFY: Modal takes full screen (100% width/height)")
    print("   ‚Ä¢ ‚úÖ VERIFY: No border radius on very small screens")
    print("   ‚Ä¢ ‚úÖ VERIFY: All content is accessible")
    print("   ‚Ä¢ ‚úÖ VERIFY: Buttons are properly sized for touch")
    
    print("\n5Ô∏è‚É£ CONTENT OVERFLOW TEST:")
    print("   ‚Ä¢ Test with 'internationalization' flashcard (long word)")
    print("   ‚Ä¢ ‚úÖ VERIFY: Modal title handles long words gracefully")
    print("   ‚Ä¢ ‚úÖ VERIFY: Audio options list scrolls if many options")
    print("   ‚Ä¢ ‚úÖ VERIFY: No horizontal scrolling occurs")
    print("   ‚Ä¢ ‚úÖ VERIFY: All buttons remain visible and clickable")
    
    print("\n6Ô∏è‚É£ BUTTON FUNCTIONALITY TEST:")
    print("   ‚Ä¢ Test all buttons in the modal")
    print("   ‚Ä¢ ‚úÖ VERIFY: Preview buttons work correctly")
    print("   ‚Ä¢ ‚úÖ VERIFY: Cancel button closes modal")
    print("   ‚Ä¢ ‚úÖ VERIFY: Keep Current button works")
    print("   ‚Ä¢ ‚úÖ VERIFY: Confirm Selection button works")
    print("   ‚Ä¢ ‚úÖ VERIFY: Close button (√ó) works")
    
    print("\n7Ô∏è‚É£ RESPONSIVE BEHAVIOR TEST:")
    print("   ‚Ä¢ Open modal and resize browser window")
    print("   ‚Ä¢ ‚úÖ VERIFY: Modal adapts to new screen size")
    print("   ‚Ä¢ ‚úÖ VERIFY: Layout changes smoothly")
    print("   ‚Ä¢ ‚úÖ VERIFY: No content is cut off during resize")
    print("   ‚Ä¢ ‚úÖ VERIFY: Buttons remain accessible")
    
    print("\nüéØ EXPECTED BEHAVIOR:")
    print("-" * 40)
    print("‚Ä¢ Modal properly contains all content")
    print("‚Ä¢ Buttons never overflow outside modal boundaries")
    print("‚Ä¢ Responsive design works on all screen sizes")
    print("‚Ä¢ Content scrolls vertically when needed")
    print("‚Ä¢ No horizontal scrolling occurs")
    print("‚Ä¢ Touch targets are adequate for mobile")
    print("‚Ä¢ Modal adapts to different content lengths")
    
    print("\n‚ö†Ô∏è SIGNS OF REMAINING ISSUES:")
    print("-" * 40)
    print("‚ùå Buttons appear outside modal boundaries")
    print("‚ùå Horizontal scrolling occurs")
    print("‚ùå Content is cut off or inaccessible")
    print("‚ùå Modal doesn't resize properly on mobile")
    print("‚ùå Touch targets are too small")
    print("‚ùå Layout breaks with long words")
    print("‚ùå Footer buttons overlap or are misaligned")

def print_debug_commands():
    """Print debug commands for modal layout troubleshooting"""
    print("\nüîß DEBUG COMMANDS (Run in Browser Console):")
    print("-" * 60)
    print("// Check modal dimensions:")
    print("const modal = document.querySelector('.audio-modal-content');")
    print("if (modal) {")
    print("  const rect = modal.getBoundingClientRect();")
    print("  console.log('Modal dimensions:', {")
    print("    width: rect.width,")
    print("    height: rect.height,")
    print("    top: rect.top,")
    print("    left: rect.left")
    print("  });")
    print("}")
    print("")
    print("// Check for overflow:")
    print("const body = document.querySelector('.audio-modal-body');")
    print("if (body) {")
    print("  console.log('Body scroll info:', {")
    print("    scrollHeight: body.scrollHeight,")
    print("    clientHeight: body.clientHeight,")
    print("    scrollTop: body.scrollTop,")
    print("    hasOverflow: body.scrollHeight > body.clientHeight")
    print("  });")
    print("}")
    print("")
    print("// Check button positions:")
    print("const buttons = document.querySelectorAll('.audio-modal-footer button');")
    print("buttons.forEach((btn, i) => {")
    print("  const rect = btn.getBoundingClientRect();")
    print("  console.log(`Button ${i}:`, {")
    print("    width: rect.width,")
    print("    right: rect.right,")
    print("    bottom: rect.bottom")
    print("  });")
    print("});")

if __name__ == '__main__':
    print("üöÄ Enhanced Audio Modal Layout Testing")
    print("=" * 60)
    
    try:
        # Create test data
        user, deck, cards = create_modal_test_data()
        
        # Check CSS improvements
        css_ok = check_css_improvements()
        
        # Print testing guide
        print_modal_testing_guide()
        print_debug_commands()
        
        print(f"\nüéâ Modal layout test setup completed!")
        print(f"üìä CSS improvements: {'‚úÖ PASS' if css_ok else '‚ùå FAIL'}")
        print(f"üë§ Test user: {user.email}")
        print(f"üìö Test deck: {deck.name} (ID: {deck.id})")
        print(f"üîó Test URL: http://localhost:8000/deck/{deck.id}/")
        
        if css_ok:
            print("\nüöÄ Ready for modal layout testing!")
            print("Start the development server and follow the testing guide above.")
            print("\nKey improvements made:")
            print("‚Ä¢ Flexbox layout for proper content containment")
            print("‚Ä¢ Improved modal sizing (700px max width)")
            print("‚Ä¢ Better responsive design for all screen sizes")
            print("‚Ä¢ Proper button layout and overflow prevention")
            print("‚Ä¢ Content scrolling without horizontal overflow")
        else:
            print("\n‚ö†Ô∏è CSS issues found. Please review the errors above.")
        
    except Exception as e:
        print(f"‚ùå Error during testing: {e}")
        import traceback
        traceback.print_exc()
