#!/usr/bin/env python
"""
Test script to verify automatic timer pause/resume functionality in study page
"""
import os
import sys
import django

# Add the parent directory to Python path so we can import Django modules
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Setup Django environment
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'learn_english_project.settings')
django.setup()

from django.contrib.auth import get_user_model
from vocabulary.models import Flashcard, Deck

User = get_user_model()

def create_timer_test_data():
    """Create test data for timer functionality testing"""
    print("üîß Setting up test data for study timer pause/resume testing...")
    
    # Get or create test user
    user, created = User.objects.get_or_create(
        email='timer-test@example.com',
        defaults={'is_active': True}
    )
    if created:
        user.set_password('testpass123')
        user.save()
        print(f"‚úÖ Created test user: {user.email}")
    else:
        print(f"‚úÖ Using existing test user: {user.email}")
    
    # Create test deck
    deck, created = Deck.objects.get_or_create(
        name='Timer Test Deck',
        user=user
    )
    if created:
        print(f"‚úÖ Created test deck: {deck.name}")
    else:
        print(f"‚úÖ Using existing test deck: {deck.name}")
    
    # Create test flashcards for study session
    test_words = [
        {
            'word': 'focus',
            'phonetic': '/Ààfo ä.k…ôs/',
            'part_of_speech': 'verb',
            'audio_url': 'https://dictionary.cambridge.org/media/english/us_pron/f/foc/focus/focus.mp3'
        },
        {
            'word': 'timer',
            'phonetic': '/Ààta…™.m…ôr/',
            'part_of_speech': 'noun',
            'audio_url': 'https://dictionary.cambridge.org/media/english/us_pron/t/tim/timer/timer.mp3'
        },
        {
            'word': 'pause',
            'phonetic': '/p…îÀêz/',
            'part_of_speech': 'verb',
            'audio_url': 'https://dictionary.cambridge.org/media/english/us_pron/p/pau/pause/pause.mp3'
        },
        {
            'word': 'resume',
            'phonetic': '/r…™ÀàzuÀêm/',
            'part_of_speech': 'verb',
            'audio_url': 'https://dictionary.cambridge.org/media/english/us_pron/r/res/resum/resume.mp3'
        },
        {
            'word': 'study',
            'phonetic': '/Ààst åd.i/',
            'part_of_speech': 'verb',
            'audio_url': 'https://dictionary.cambridge.org/media/english/us_pron/s/stu/study/study.mp3'
        }
    ]
    
    created_cards = []
    for word_data in test_words:
        flashcard, created = Flashcard.objects.get_or_create(
            word=word_data['word'],
            user=user,
            deck=deck,
            defaults=word_data
        )
        created_cards.append(flashcard)
        
        if created:
            print(f"‚úÖ Created flashcard: {flashcard.word} (ID: {flashcard.id})")
        else:
            print(f"‚úÖ Using existing flashcard: {flashcard.word} (ID: {flashcard.id})")
    
    return user, deck, created_cards

def check_timer_implementation():
    """Check that the timer pause/resume implementation is in place"""
    print("\nüß™ Checking timer pause/resume implementation...")
    
    js_path = os.path.join(
        os.path.dirname(os.path.dirname(__file__)),
        'static', 'js', 'study.js'
    )
    
    css_path = os.path.join(
        os.path.dirname(os.path.dirname(__file__)),
        'static', 'css', 'study.css'
    )
    
    if not os.path.exists(js_path):
        print(f"‚ùå JavaScript file not found: {js_path}")
        return False
    
    if not os.path.exists(css_path):
        print(f"‚ùå CSS file not found: {css_path}")
        return False
    
    with open(js_path, 'r', encoding='utf-8') as f:
        js_content = f.read()
    
    with open(css_path, 'r', encoding='utf-8') as f:
        css_content = f.read()
    
    # Check for key implementation features
    js_features = {
        'pause_variables': 'timerPaused' in js_content and 'pausedTime' in js_content,
        'pause_function': 'function pauseStudyTimer()' in js_content,
        'resume_function': 'function resumeStudyTimer()' in js_content,
        'visibility_api': 'visibilitychange' in js_content,
        'focus_blur_events': 'addEventListener(\'blur\'' in js_content and 'addEventListener(\'focus\'' in js_content,
        'paused_display': '(Paused)' in js_content,
        'css_class_toggle': 'classList.add(\'paused\')' in js_content
    }
    
    css_features = {
        'paused_class': '.timer-display.paused' in css_content,
        'paused_animation': 'pulse-paused' in css_content,
        'paused_background': 'linear-gradient(135deg, #f59e0b, #d97706)' in css_content
    }
    
    print("üìã JavaScript implementation verification:")
    print("-" * 50)
    
    for feature, found in js_features.items():
        status = "‚úÖ PASS" if found else "‚ùå FAIL"
        print(f"{feature}: {status}")
    
    print("\nüìã CSS implementation verification:")
    print("-" * 50)
    
    for feature, found in css_features.items():
        status = "‚úÖ PASS" if found else "‚ùå FAIL"
        print(f"{feature}: {status}")
    
    all_features = all(js_features.values()) and all(css_features.values())
    
    if all_features:
        print("\n‚úÖ All timer pause/resume features implemented!")
    else:
        print("\n‚ùå Some timer features are missing!")
    
    return all_features

def print_timer_testing_guide():
    """Print comprehensive testing guide for timer pause/resume functionality"""
    print("\nüß™ STUDY TIMER PAUSE/RESUME TESTING GUIDE")
    print("=" * 70)
    
    print("\nüéØ FUNCTIONALITY IMPLEMENTED:")
    print("-" * 40)
    print("‚úÖ Automatic timer pause when tab loses focus")
    print("‚úÖ Automatic timer resume when tab gains focus")
    print("‚úÖ Visual indication of paused state")
    print("‚úÖ Accurate time tracking (excludes paused time)")
    print("‚úÖ Cross-browser compatibility")
    
    print("\nüìã TESTING PROCEDURE:")
    print("-" * 40)
    
    print("\n1Ô∏è‚É£ BASIC TIMER FUNCTIONALITY TEST:")
    print("   ‚Ä¢ Navigate to: http://localhost:8000/study/")
    print("   ‚Ä¢ Select 'Timer Test Deck' and start studying")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer starts counting (00:01, 00:02, etc.)")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer display shows green background")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer format is MM:SS or HH:MM:SS")
    
    print("\n2Ô∏è‚É£ TAB SWITCHING PAUSE TEST:")
    print("   ‚Ä¢ Start a study session with timer running")
    print("   ‚Ä¢ Switch to another browser tab")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer automatically pauses")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer display shows orange background")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer text shows '(Paused)' indicator")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer display has pulsing animation")
    print("   ‚Ä¢ Switch back to study tab")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer automatically resumes")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer display returns to green background")
    print("   ‚Ä¢ ‚úÖ VERIFY: '(Paused)' indicator disappears")
    
    print("\n3Ô∏è‚É£ WINDOW FOCUS PAUSE TEST:")
    print("   ‚Ä¢ Start a study session with timer running")
    print("   ‚Ä¢ Switch to another application (Alt+Tab)")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer pauses when window loses focus")
    print("   ‚Ä¢ ‚úÖ VERIFY: Visual paused state is shown")
    print("   ‚Ä¢ Return to browser window")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer resumes automatically")
    print("   ‚Ä¢ ‚úÖ VERIFY: Visual state returns to normal")
    
    print("\n4Ô∏è‚É£ BROWSER MINIMIZE TEST:")
    print("   ‚Ä¢ Start a study session with timer running")
    print("   ‚Ä¢ Minimize the browser window")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer pauses (check when restored)")
    print("   ‚Ä¢ Restore the browser window")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer resumes from paused time")
    
    print("\n5Ô∏è‚É£ ACCURATE TIME TRACKING TEST:")
    print("   ‚Ä¢ Start study session, note timer at 00:30")
    print("   ‚Ä¢ Switch tabs for 10 seconds")
    print("   ‚Ä¢ Return to study tab")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer shows approximately 00:30 (not 00:40)")
    print("   ‚Ä¢ ‚úÖ VERIFY: Paused time is not counted in total")
    
    print("\n6Ô∏è‚É£ MULTIPLE PAUSE/RESUME CYCLES TEST:")
    print("   ‚Ä¢ Start study session")
    print("   ‚Ä¢ Switch tabs multiple times (pause/resume cycles)")
    print("   ‚Ä¢ ‚úÖ VERIFY: Each pause/resume cycle works correctly")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer accurately tracks only active time")
    print("   ‚Ä¢ ‚úÖ VERIFY: Visual states change correctly each time")
    
    print("\n7Ô∏è‚É£ STUDY SESSION COMPLETION TEST:")
    print("   ‚Ä¢ Complete a study session with pause/resume cycles")
    print("   ‚Ä¢ ‚úÖ VERIFY: Final time reflects only active study time")
    print("   ‚Ä¢ ‚úÖ VERIFY: Timer resets properly for new session")
    print("   ‚Ä¢ ‚úÖ VERIFY: No paused state carries over to new session")
    
    print("\n8Ô∏è‚É£ BROWSER COMPATIBILITY TEST:")
    print("   ‚Ä¢ Test in Chrome, Firefox, Safari, Edge")
    print("   ‚Ä¢ ‚úÖ VERIFY: Page Visibility API works in all browsers")
    print("   ‚Ä¢ ‚úÖ VERIFY: Focus/blur events work as fallback")
    print("   ‚Ä¢ ‚úÖ VERIFY: Visual indicators display correctly")
    
    print("\nüéØ EXPECTED BEHAVIOR:")
    print("-" * 40)
    print("‚Ä¢ Timer pauses automatically when page loses focus")
    print("‚Ä¢ Timer resumes automatically when page gains focus")
    print("‚Ä¢ Paused state is clearly indicated visually")
    print("‚Ä¢ Only active study time is counted")
    print("‚Ä¢ No user intervention required")
    print("‚Ä¢ Works across different browsers")
    print("‚Ä¢ Smooth transitions between paused/active states")
    
    print("\n‚ö†Ô∏è SIGNS OF ISSUES:")
    print("-" * 40)
    print("‚ùå Timer continues counting when tab is not active")
    print("‚ùå Timer doesn't pause when switching applications")
    print("‚ùå No visual indication of paused state")
    print("‚ùå Paused time is included in total study time")
    print("‚ùå Timer doesn't resume when returning to tab")
    print("‚ùå Visual states don't change correctly")
    print("‚ùå Console shows JavaScript errors")

def print_debug_commands():
    """Print debug commands for timer troubleshooting"""
    print("\nüîß DEBUG COMMANDS (Run in Browser Console):")
    print("-" * 60)
    print("// Check timer state:")
    print("console.log('Timer state:', {")
    print("  studyStartTime: window.studyStartTime,")
    print("  timerPaused: window.timerPaused,")
    print("  pausedTime: window.pausedTime,")
    print("  timerInterval: window.timerInterval")
    print("});")
    print("")
    print("// Check Page Visibility API support:")
    print("console.log('Visibility API:', {")
    print("  hidden: document.hidden,")
    print("  visibilityState: document.visibilityState,")
    print("  hasFocus: document.hasFocus()")
    print("});")
    print("")
    print("// Manually test pause/resume:")
    print("// (Only works if study session is active)")
    print("pauseStudyTimer(); // Pause timer")
    print("resumeStudyTimer(); // Resume timer")
    print("")
    print("// Check timer display element:")
    print("const timerDisplay = document.getElementById('timerDisplay');")
    print("console.log('Timer display:', {")
    print("  element: timerDisplay,")
    print("  classes: timerDisplay?.className,")
    print("  text: timerDisplay?.textContent")
    print("});")

if __name__ == '__main__':
    print("üöÄ Study Timer Pause/Resume Functionality Test")
    print("=" * 60)
    
    try:
        # Create test data
        user, deck, cards = create_timer_test_data()
        
        # Check implementation
        impl_ok = check_timer_implementation()
        
        # Print testing guide
        print_timer_testing_guide()
        print_debug_commands()
        
        print(f"\nüéâ Timer test setup completed!")
        print(f"üìä Implementation: {'‚úÖ PASS' if impl_ok else '‚ùå FAIL'}")
        print(f"üë§ Test user: {user.email}")
        print(f"üìö Test deck: {deck.name} (ID: {deck.id})")
        print(f"üîó Test URL: http://localhost:8000/study/")
        
        if impl_ok:
            print("\nüöÄ Ready for timer pause/resume testing!")
            print("Start the development server and follow the testing guide above.")
            print("\nKey features implemented:")
            print("‚Ä¢ Automatic pause when tab loses focus")
            print("‚Ä¢ Automatic resume when tab gains focus")
            print("‚Ä¢ Visual paused state indication")
            print("‚Ä¢ Accurate time tracking (excludes paused time)")
            print("‚Ä¢ Cross-browser compatibility")
        else:
            print("\n‚ö†Ô∏è Implementation issues found. Please review the errors above.")
        
    except Exception as e:
        print(f"‚ùå Error during testing: {e}")
        import traceback
        traceback.print_exc()
