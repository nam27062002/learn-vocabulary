{% extends "base.html" %}
{% load static %}

{% block title %}
{{ manual_texts.study }} - {{ manual_texts.learn_english }}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/study.css' %}" />
<style>
  #studyArea {
    position: relative;
  }
  .loading-indicator {
    display: none; /* Hidden by default */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100;
  }
  .spinner {
    border: 8px solid #f3f3f3; /* Light grey */
    border-top: 8px solid #3498db; /* Blue */
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  .flashcard-container.loading-state {
    opacity: 0.3;
    pointer-events: none;
  }

  /* Edit Card Button Styling */
  .edit-card-button {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #cbd5e1;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .edit-card-button:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #6a6cff;
    transform: translateY(-1px);
  }

  /* Edit Card Modal Styling */
  .edit-card-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
  }

  .edit-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(4px);
    padding: 20px;
  }

  .edit-modal-content {
    background: linear-gradient(145deg, #1f2937, #111827);
    border-radius: 16px;
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
  }

  .edit-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 24px 0 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 24px;
    padding-bottom: 16px;
  }

  .edit-modal-title {
    color: #f1f5f9;
    font-size: 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 0;
  }

  .close-edit-modal {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #cbd5e1;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-edit-modal:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #f1f5f9;
    transform: scale(1.05);
  }

  .edit-modal-body {
    padding: 0 24px;
  }

  .edit-card-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-label {
    color: #cbd5e1;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .form-input {
    background: rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.1);
    color: #f1f5f9;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.2s ease;
  }

  .form-input:focus {
    outline: none;
    border-color: #6366f1;
    background: rgba(0, 0, 0, 0.4);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .form-input::placeholder {
    color: #6b7280;
  }

  .form-select {
    /* Aggressively remove ALL browser styling */
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    -ms-appearance: none !important;
    appearance: none !important;

    /* Reset all background properties */
    background: #374151 !important;
    background-image: none !important;
    background-repeat: no-repeat !important;
    background-position: right 12px center !important;
    background-size: 0 !important;

    /* Positioning and spacing */
    padding-right: 40px !important;
    cursor: pointer;
    position: relative;

    /* Border and basic styling */
    border: 1px solid #4b5563;
    border-radius: 8px;
    color: #f1f5f9;
    font-size: 14px;
    line-height: 1.5;
  }

  /* Remove browser-specific arrows with pseudo-selectors */
  .form-select::-webkit-appearance {
    -webkit-appearance: none !important;
  }

  .form-select::-moz-appearance {
    -moz-appearance: none !important;
  }

  .form-select::-ms-expand {
    display: none !important;
  }

  /* Add custom arrow using ::after pseudo-element */
  .form-select {
    background-image: linear-gradient(45deg, transparent 50%, #6b7280 50%),
                      linear-gradient(135deg, #6b7280 50%, transparent 50%) !important;
    background-position: calc(100% - 20px) calc(1em + 2px),
                         calc(100% - 15px) calc(1em + 2px) !important;
    background-size: 5px 5px, 5px 5px !important;
    background-repeat: no-repeat !important;
  }

  .form-select:focus {
    border-color: #6366f1;
    background-image: linear-gradient(45deg, transparent 50%, #6366f1 50%),
                      linear-gradient(135deg, #6366f1 50%, transparent 50%) !important;
  }

  .form-select option {
    background: #1f2937;
    color: #f1f5f9;
    padding: 8px 12px;
  }



  /* Modal Footer */
  .edit-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 24px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: 24px;
  }

  .cancel-edit-btn,
  .save-edit-btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    border: none;
  }

  .cancel-edit-btn {
    background: rgba(107, 114, 128, 0.2);
    color: #9ca3af;
    border: 1px solid rgba(107, 114, 128, 0.3);
  }

  .cancel-edit-btn:hover {
    background: rgba(107, 114, 128, 0.3);
    color: #d1d5db;
  }

  .save-edit-btn {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border: 1px solid rgba(99, 102, 241, 0.3);
  }

  .save-edit-btn:hover {
    background: linear-gradient(135deg, #5b21b6, #7c3aed);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
  }

  .save-edit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* CEFR Level Badge Styles */
  .card-cefr-level {
    margin: 8px 0;
    display: flex;
    justify-content: center;
  }

  .cefr-level-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.025em;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.2s ease;
    color: white;
    cursor: help;
  }

  .cefr-level-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  }

  /* Responsive Design */
  @media (max-width: 640px) {
    .edit-modal-overlay {
      padding: 10px;
    }

    .edit-modal-content {
      max-height: 95vh;
    }

    .edit-modal-header,
    .edit-modal-body,
    .edit-modal-footer {
      padding-left: 16px;
      padding-right: 16px;
    }

    .edit-modal-footer {
      flex-direction: column;
    }

    .cancel-edit-btn,
    .save-edit-btn {
      width: 100%;
      justify-content: center;
    }
  }

  /* Animation */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="study-page">
  <div class="study-header">
    <h1 class="study-title">📖 {{ manual_texts.study }}</h1>
    <p class="study-subtitle">{{ manual_texts.platform_description }}</p>
  </div>

  <!-- Study Mode Selection -->
  <div class="study-mode-section">
    <h2 class="section-title">{{ manual_texts.study_mode }}</h2>

    <!-- Mode Slider Container -->
    <div class="mode-slider-container">
      <!-- Navigation Arrows -->
      <button
        class="slider-nav slider-nav-prev"
        id="sliderPrev"
        aria-label="Previous mode"
      >
        <span class="nav-arrow">‹</span>
      </button>

      <!-- Slider Wrapper -->
      <div
        class="mode-slider-wrapper"
        role="region"
        aria-label="Study mode selection"
      >
        <div class="mode-slider" id="modeSlider" role="tablist">
          <!-- Deck Study Mode -->
          <div
            class="mode-slide active"
            data-mode="decks"
            role="tabpanel"
            aria-label="Deck study mode"
          >
            <label class="mode-option">
              <input
                type="radio"
                name="study_mode"
                value="decks"
                checked
                aria-describedby="deck-description"
              />
              <div class="mode-card">
                <div class="mode-icon" aria-hidden="true">📚</div>
                <div class="mode-content">
                  <h3>{{ manual_texts.normal_study_by_decks }}</h3>
                  <p id="deck-description">
                    {{ manual_texts.deck_study_description }}
                  </p>
                </div>
              </div>
            </label>
          </div>

          <!-- Random Study Mode -->
          <div
            class="mode-slide"
            data-mode="random"
            role="tabpanel"
            aria-label="Random study mode"
          >
            <label class="mode-option">
              <input
                type="radio"
                name="study_mode"
                value="random"
                aria-describedby="random-description"
              />
              <div class="mode-card">
                <div class="mode-icon" aria-hidden="true">🎲</div>
                <div class="mode-content">
                  <h3>{{ manual_texts.study_random_words }}</h3>
                  <p id="random-description">
                    {{ manual_texts.random_study_description }}
                  </p>
                </div>
              </div>
            </label>
          </div>

          <!-- Review Mode -->
          <div
            class="mode-slide"
            data-mode="review"
            role="tabpanel"
            aria-label="Review incorrect words mode"
          >
            <label class="mode-option" id="reviewModeOption">
              <input
                type="radio"
                name="study_mode"
                value="review"
                aria-describedby="review-description"
              />
              <div class="mode-card">
                <div class="mode-icon" aria-hidden="true">🔄</div>
                <div class="mode-content">
                  <h3>{{ manual_texts.review_incorrect_words }}</h3>
                  <p id="review-description">
                    {{ manual_texts.review_study_description }}
                  </p>
                  <div
                    class="review-count"
                    id="reviewCount"
                    style="display: none"
                  >
                    <span id="reviewCountText"
                      >0 {{ manual_texts.incorrect_words_count }}</span
                    >
                  </div>
                </div>
              </div>
            </label>
          </div>

          <!-- Favorites Mode -->
          <div
            class="mode-slide"
            data-mode="favorites"
            role="tabpanel"
            aria-label="Study favorite words mode"
          >
            <label class="mode-option" id="favoritesModeOption">
              <input
                type="radio"
                name="study_mode"
                value="favorites"
                aria-describedby="favorites-description"
              />
              <div class="mode-card">
                <div class="mode-icon" aria-hidden="true">❤️</div>
                <div class="mode-content">
                  <h3>{{ manual_texts.study_favorites|default:"Study Favorites" }}</h3>
                  <p id="favorites-description">
                    {{ manual_texts.favorites_study_description|default:"Study your favorite vocabulary words" }}
                  </p>
                  <div
                    class="favorites-count"
                    id="favoritesCount"
                    style="display: none"
                  >
                    <span id="favoritesCountText"
                      >0 {{ manual_texts.favorite_words_count|default:"favorite words" }}</span
                    >
                  </div>
                </div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Navigation Arrows -->
      <button
        class="slider-nav slider-nav-next"
        id="sliderNext"
        aria-label="Next mode"
      >
        <span class="nav-arrow">›</span>
      </button>
    </div>

    <!-- Slider Indicators -->
    <div class="slider-indicators">
      <button
        class="indicator active"
        data-slide="0"
        aria-label="Deck study mode"
      ></button>
      <button
        class="indicator"
        data-slide="1"
        aria-label="Random study mode"
      ></button>
      <button
        class="indicator"
        data-slide="2"
        aria-label="Review mode"
      ></button>
      <button
        class="indicator"
        data-slide="3"
        aria-label="Favorites study mode"
      ></button>
    </div>
  </div>

  <!-- Deck Study Options -->
  <div id="deckStudyOptions" class="study-options-section">
    <h3 class="options-title">{{ manual_texts.select_decks }}</h3>

    <!-- Deck selector button -->
    <div class="deck-selector-button-container">
      <button type="button" id="openDeckSelector" class="deck-selector-button">
        <i class="fas fa-layer-group deck-icon"></i>
        <div class="button-content">
          <span class="button-label">{{ manual_texts.select_decks }}</span>
          <span id="selectedDecksPreview" class="selected-preview">{{ manual_texts.no_decks_selected }}</span>
        </div>
        <i class="fas fa-chevron-right button-arrow"></i>
      </button>
    </div>

    <button id="startBtn" class="start-button">
      <span class="button-icon">🚀</span>
      {{ manual_texts.start_study }}
    </button>
  </div>

  <!-- Random Study Options -->
  <div id="randomStudyOptions" class="study-options-section hidden">
    <h3 class="options-title">{{ manual_texts.study_random_words }}</h3>

    <div class="random-options">
      <div class="word-count-input">
        <label for="randomWordCount">{{ manual_texts.number_of_words }}</label>
        <input
          type="number"
          id="randomWordCount"
          min="1"
          max="100"
          value="10"
        />
      </div>

      <div class="available-words-info">
        <span class="info-label">{{ manual_texts.available_words }}:</span>
        <span id="totalWordsAvailable" class="info-value"
          >{{ total_words_available }}</span
        >
      </div>
    </div>

    <button id="startRandomBtn" class="start-button">
      <span class="button-icon">🎲</span>
      {{ manual_texts.start_study }}
    </button>
  </div>

  <!-- Review Study Options -->
  <div id="reviewStudyOptions" class="study-options-section hidden">
    <h3 class="options-title">{{ manual_texts.review_incorrect_words }}</h3>

    <div class="review-options">
      <div class="review-info">
        <div class="review-description">
          <p>{{ manual_texts.review_mode_description }}</p>
          <div class="review-details" id="reviewDetails" style="display: none">
            <div class="review-breakdown">
              <div class="breakdown-item">
                <span class="breakdown-label"
                  >{{ manual_texts.multiple_choice }}:</span
                >
                <span class="breakdown-count" id="mcCount">0</span>
              </div>
              <div class="breakdown-item">
                <span class="breakdown-label"
                  >{{ manual_texts.input_mode }}:</span
                >
                <span class="breakdown-count" id="typeCount">0</span>
              </div>
              <div class="breakdown-item">
                <span class="breakdown-label"
                  >{{ manual_texts.dictation_mode }}:</span
                >
                <span class="breakdown-count" id="dictationCount">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <button id="startReviewBtn" class="start-button" disabled>
      <span class="button-icon">🔄</span>
      {{ manual_texts.start_review }}
    </button>
  </div>

  <div id="studyArea" class="study-area">
    <div id="loadingIndicator" class="loading-indicator">
        <div class="spinner"></div>
    </div>
    <div class="study-header-bar">
      <button id="backBtn" class="back-button">
        <i class="fas fa-arrow-left"></i>
        {{ manual_texts.back_to_selection }}
      </button>
      <div class="header-controls">
        <div id="timerDisplay" class="timer-display">
          <i class="fas fa-clock"></i>
          <span id="timerText">00:00</span>
        </div>
        <div id="statsInfo" class="stats-display">
          {{ manual_texts.correct }}: 0 | {{ manual_texts.incorrect }}: 0
        </div>
        <div class="audio-settings">
          <label class="audio-toggle">
            <input type="checkbox" id="audioToggle" checked />
            <span class="toggle-slider"></span>
            <span class="toggle-label">
              <i class="fas fa-volume-up"></i>
              {{ manual_texts.sound_feedback }}
            </span>
          </label>
        </div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div id="progressContainer" class="progress-container" style="display: none;">
      <div class="progress-info">
        <span id="progressText" class="progress-text">{{ manual_texts.progress|default:'Progress' }}: 0/0</span>
        <span id="progressPercentage" class="progress-percentage">0%</span>
      </div>
      <div class="progress-bar-wrapper">
        <div class="progress-bar">
          <div id="progressBarFill" class="progress-bar-fill"></div>
        </div>
      </div>
    </div>

    <div id="cardBox" class="flashcard-container">
      <div class="card-header">
        <div class="word-section">
          <h2 id="cardWord" class="card-word"></h2>
          <button id="audioButton" class="audio-button" style="display: none">
            <i class="fas fa-volume-up"></i>
          </button>
          <div class="recording-controls" style="display: none;">
            <button id="recordButton" class="record-button" title="{{ manual_texts.record_pronunciation|default:'Record your pronunciation' }}">
              <i class="fas fa-microphone" id="recordIcon"></i>
            </button>
            <button id="playRecordingButton" class="play-recording-button" style="display: none;" title="{{ manual_texts.play_your_audio|default:'Play your audio' }}">
              <i class="fas fa-play"></i>
            </button>
          </div>
          <button id="favoriteButton" class="favorite-button" style="display: none" title="{{ manual_texts.toggle_favorite|default:'Toggle favorite' }}">
            <span class="favorite-icon">🤍</span>
          </button>
          <button id="blacklistButton" class="blacklist-button" style="display: none" title="{{ manual_texts.toggle_blacklist|default:'Toggle blacklist' }}">
            <span class="blacklist-icon">🔘</span>
          </button>
          <button id="editCardButton" class="edit-card-button" style="display: none" title="{{ manual_texts.edit_card|default:'Edit card' }}">
            <i class="fas fa-edit"></i>
          </button>
        </div>
        <div id="cardCefrLevel" class="card-cefr-level" style="display: none;"></div>
        <p id="cardPhonetic" class="card-phonetic"></p>
      </div>

      <img id="cardImage" src="" alt="image" class="card-image" />

      <div id="answerSection" class="answer-section">
        <div id="cardDefs" class="card-definitions"></div>
        <div id="optionsArea" class="options-area"></div>
        <div id="feedbackMsg" class="feedback-message"></div>
        <div id="detailedFeedbackArea" class="detailed-feedback-area" style="display: none;"></div>
      </div>

      <div id="gradeButtons" class="grade-buttons">
        <button class="grade-btn grade-again" data-grade="0">
          <span class="grade-icon">😰</span>
          {{ manual_texts.grade_again }}
        </button>
        <button class="grade-btn grade-hard" data-grade="1">
          <span class="grade-icon">😅</span>
          {{ manual_texts.grade_hard }}
        </button>
        <button class="grade-btn grade-good" data-grade="2">
          <span class="grade-icon">😊</span>
          {{ manual_texts.grade_good }}
        </button>
        <button class="grade-btn grade-easy" data-grade="3">
          <span class="grade-icon">😎</span>
          {{ manual_texts.grade_easy }}
        </button>
      </div>

      <p id="noCardMsg" class="no-cards-message">
        {{ manual_texts.no_cards_due }}
      </p>
    </div>

    <!-- Edit Card Modal -->
    <div id="editCardModal" class="edit-card-modal" style="display: none;">
      <div class="edit-modal-overlay">
        <div class="edit-modal-content">
          <div class="edit-modal-header">
            <h3 class="edit-modal-title">
              <i class="fas fa-edit"></i>
              {{ manual_texts.edit_card|default:'Edit Card' }}
            </h3>
            <button id="closeEditModal" class="close-edit-modal">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="edit-modal-body">
            <form id="editCardForm" class="edit-card-form">
              <!-- Word Field -->
              <div class="form-group">
                <label for="editWord" class="form-label">
                  {{ manual_texts.english_word|default:'English Word' }}
                </label>
                <input
                  type="text"
                  id="editWord"
                  name="word"
                  class="form-input"
                  required
                />
              </div>

              <!-- Part of Speech Field -->
              <div class="form-group">
                <label for="editPartOfSpeech" class="form-label">
                  {{ manual_texts.part_of_speech|default:'Part of Speech' }}
                </label>
                <select
                  id="editPartOfSpeech"
                  name="part_of_speech"
                  class="form-input form-select"
                >
                  <option value="">{{ manual_texts.select_part_of_speech|default:'Select part of speech...' }}</option>
                  <option value="noun">{{ manual_texts.noun|default:'Noun' }}</option>
                  <option value="verb">{{ manual_texts.verb|default:'Verb' }}</option>
                  <option value="adjective">{{ manual_texts.adjective|default:'Adjective' }}</option>
                  <option value="adverb">{{ manual_texts.adverb|default:'Adverb' }}</option>
                  <option value="pronoun">{{ manual_texts.pronoun|default:'Pronoun' }}</option>
                  <option value="preposition">{{ manual_texts.preposition|default:'Preposition' }}</option>
                  <option value="conjunction">{{ manual_texts.conjunction|default:'Conjunction' }}</option>
                  <option value="interjection">{{ manual_texts.interjection|default:'Interjection' }}</option>
                  <option value="article">{{ manual_texts.article|default:'Article' }}</option>
                  <option value="determiner">{{ manual_texts.determiner|default:'Determiner' }}</option>
                  <option value="modal">{{ manual_texts.modal|default:'Modal' }}</option>
                  <option value="auxiliary">{{ manual_texts.auxiliary|default:'Auxiliary' }}</option>
                  <option value="phrasal verb">{{ manual_texts.phrasal_verb|default:'Phrasal Verb' }}</option>
                  <option value="idiom">{{ manual_texts.idiom|default:'Idiom' }}</option>
                  <option value="phrase">{{ manual_texts.phrase|default:'Phrase' }}</option>
                </select>
              </div>

              <!-- Phonetic Field -->
              <div class="form-group">
                <label for="editPhonetic" class="form-label">
                  {{ manual_texts.phonetic|default:'Phonetic' }}
                </label>
                <input
                  type="text"
                  id="editPhonetic"
                  name="phonetic"
                  class="form-input"
                  placeholder="{{ manual_texts.phonetic_placeholder|default:'e.g., /ˈwɜːrd/' }}"
                />
              </div>

              <!-- Audio URL Field -->
              <div class="form-group">
                <label for="editAudioUrl" class="form-label">
                  {{ manual_texts.audio_url|default:'Audio URL' }}
                </label>
                <input
                  type="url"
                  id="editAudioUrl"
                  name="audio_url"
                  class="form-input"
                  placeholder="{{ manual_texts.audio_url_placeholder|default:'https://example.com/audio.mp3' }}"
                />
              </div>

              <!-- Definition Fields -->
              <div class="form-group">
                <label for="editEnglishDefinition" class="form-label">
                  {{ manual_texts.english_definition|default:'English Definition' }}
                </label>
                <input
                  type="text"
                  id="editEnglishDefinition"
                  name="english_definition"
                  class="form-input"
                  placeholder="{{ manual_texts.english_definition_placeholder|default:'Enter English definition...' }}"
                  required
                />
              </div>

              <div class="form-group">
                <label for="editVietnameseDefinition" class="form-label">
                  {{ manual_texts.vietnamese_definition|default:'Vietnamese Definition' }}
                </label>
                <input
                  type="text"
                  id="editVietnameseDefinition"
                  name="vietnamese_definition"
                  class="form-input"
                  placeholder="{{ manual_texts.vietnamese_definition_placeholder|default:'Enter Vietnamese definition...' }}"
                  required
                />
              </div>
            </form>
          </div>

          <div class="edit-modal-footer">
            <button type="button" id="cancelEditBtn" class="cancel-edit-btn">
              <i class="fas fa-times"></i>
              {{ manual_texts.cancel|default:'Cancel' }}
            </button>
            <button type="button" id="saveEditBtn" class="save-edit-btn">
              <i class="fas fa-save"></i>
              {{ manual_texts.save|default:'Save' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Review Completion Success Modal -->
<div id="reviewCompletionModal" class="modal-overlay" style="display: none">
  <div class="modal-content success-modal">
    <div class="modal-header">
      <h2 class="modal-title">{{ manual_texts.review_completed_title }}</h2>
    </div>
    <div class="modal-body">
      <div class="success-icon">🎉</div>
      <p class="success-message">{{ manual_texts.review_completed_message }}</p>
    </div>
    <div class="modal-footer">
      <button id="continueStudyingBtn" class="modal-button primary">
        {{ manual_texts.continue_studying }}
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  const STUDY_CFG = {
    nextUrl: "{% url 'api_next_question' %}",
    submitUrl: "{% url 'api_submit_answer' %}",
    csrfToken: document.querySelector('meta[name="csrf-token"]').content,
    labels: {
      correct: "{{ manual_texts.correct }}",
      incorrect: "{{ manual_texts.incorrect }}",
      check: "{{ manual_texts.check }}",
      placeholder: "{{ manual_texts.answer_placeholder }}",
      grade_again: "{{ manual_texts.grade_again }}",
      grade_hard: "{{ manual_texts.grade_hard }}",
      grade_good: "{{ manual_texts.grade_good }}",
      grade_easy: "{{ manual_texts.grade_easy }}",

      no_cards_due: "{{ manual_texts.no_cards_due }}",
      play_audio: "{{ manual_texts.play_audio }}",
      listen_and_type: "{{ manual_texts.listen_and_type }}",
      type_what_you_hear: "{{ manual_texts.type_what_you_hear }}",
      correct_answer: "{{ manual_texts.correct_answer }}",
      incorrect_answer: "{{ manual_texts.incorrect_answer }}",
      replay_audio: "{{ manual_texts.replay_audio }}",
      english_label: "{{ manual_texts.english_label }}",
      vietnamese_label: "{{ manual_texts.vietnamese_label }}",
      part_of_speech: "{{ manual_texts.part_of_speech }}",
      review_completed_title: "{{ manual_texts.review_completed_title }}",
      review_completed_message: "{{ manual_texts.review_completed_message }}",
      continue_studying: "{{ manual_texts.continue_studying }}",
      favorite_words_count: "{{ manual_texts.favorite_words_count|default:'favorite words' }}",
    },
  };
</script>

<!-- Deck Selection Popup Modal -->
<div id="deckSelectorModal" class="deck-modal-overlay">
  <div class="deck-modal">
    <div class="deck-modal-header">
      <h3 class="modal-title">
        <i class="fas fa-layer-group"></i>
        {{ manual_texts.select_decks }}
      </h3>
      <button type="button" id="closeDeckModal" class="close-modal-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="deck-modal-content">
      <!-- Search and controls -->
      <div class="deck-controls">
        <div class="search-container">
          <input type="text" id="deckSearchInput" placeholder="{{ manual_texts.search_decks|default:'Search decks...' }}" class="deck-search-input">
          <i class="fas fa-search search-icon"></i>
          <button type="button" id="clearDeckSearch" class="clear-search-btn" title="{{ manual_texts.clear|default:'Clear' }}" aria-label="Clear search">
            <i class="fas fa-times-circle"></i>
          </button>
        </div>
        <div class="deck-actions">
          <button type="button" id="selectFilteredDecks" class="action-btn" title="{{ manual_texts.select_visible|default:'Select Visible' }}">
            <i class="fas fa-check-double"></i>
            {{ manual_texts.select_visible|default:'Select Visible' }}
          </button>
          <button type="button" id="selectAllDecks" class="action-btn">
            <i class="fas fa-check-square"></i>
            {{ manual_texts.select_all|default:'Select All' }}
          </button>
          <button type="button" id="deselectAllDecks" class="action-btn">
            <i class="fas fa-square"></i>
            {{ manual_texts.deselect_all|default:'Deselect All' }}
          </button>
        </div>
      </div>
      
      <!-- Selected counter -->
      <div class="selection-info">
        <span class="badge" id="selectedCount">0</span>
        <span class="selection-label">{{ manual_texts.decks_selected|default:'decks selected' }}</span>
      </div>

      <!-- Deck grid -->
      <div class="deck-grid" id="deckGrid">
        {% for d in decks %}
        <label class="deck-card" data-deck-name="{{ d.name|lower }}">
          <input type="checkbox" name="deck_ids" value="{{ d.id }}" class="deck-checkbox" />
          <div class="deck-card-content">
            <div class="deck-header">
              <span class="deck-name">{{ d.name }}</span>
              <div class="deck-check-indicator">
                <i class="fas fa-check"></i>
              </div>
            </div>
            <div class="deck-stats">
              <span class="deck-count">{{ d.flashcards.count }} {{ manual_texts.words_unit }}</span>
            </div>
          </div>
        </label>
        {% empty %}
        <p class="no-decks-message">{{ manual_texts.no_decks_available }}</p>
        {% endfor %}
      </div>
    </div>

    <div class="deck-modal-footer">
      <button type="button" id="cancelDeckSelection" class="cancel-btn">
        <i class="fas fa-times"></i>
        {{ manual_texts.cancel|default:'Cancel' }}
      </button>
      <button type="button" id="confirmDeckSelection" class="confirm-btn">
        <i class="fas fa-check"></i>
        {{ manual_texts.confirm|default:'Confirm' }}
      </button>
    </div>
  </div>
</div>

<script src="{% static 'js/study.js' %}"></script>
{% endblock %}