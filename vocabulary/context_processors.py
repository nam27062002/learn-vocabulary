from django.utils import translation
from django.conf import settings
import json

# Only import gettext if i18n is enabled
if getattr(settings, 'USE_I18N', False):
    from django.utils.translation import gettext as _
else:
    # Fallback function when i18n is disabled
    def _(message):
        return str(message)

def i18n_compatible_translations(request):
    """
    Hybrid translation context processor that provides both Django i18n
    and legacy manual_texts for backward compatibility during migration.
    """
    # Get language from session first (for legacy system), then fall back to Django's i18n
    current_lang = request.session.get('django_language', translation.get_language())

    # If Django i18n is disabled, default to 'en'
    if not current_lang:
        current_lang = 'en'

    # Legacy translations for backward compatibility
    # These will be gradually removed as templates are migrated to use {% trans %}
    legacy_translations = {
        'en': {
            'learn_english': 'Learn English',
            'home': 'Home',
            'flashcards': 'Flashcards',
            'add_word': 'Add Word',
            'study': 'Study',
            'statistics': 'Statistics',
            'dashboard': 'Dashboard',
            'welcome_message': 'Welcome to LearnEnglish',
            'platform_description': 'Your personal vocabulary learning platform',
            'total_cards': 'Total Cards',
            'recent_cards': 'Recent Cards',
            'progress': 'Progress',
            'add_new_words': 'Add New Words',
            'study_cards': 'Study Cards',
            'add_flashcard': 'Add Flashcard',
            'add_new_flashcard': 'Add New Flashcard',
            'add_vocabulary_description': 'Add new vocabulary to your collection',
            'my_flashcards': 'My Flashcards',
            'vocabulary_collection': 'Your vocabulary collection',
            # Authentication texts
            'login_title': 'Login',
            'signup_title': 'Sign Up',
            'welcome_back': 'Welcome back!',
            'login_subtitle': 'Sign in to your account',
            'create_account': 'Create Account',
            'signup_subtitle': 'Start your vocabulary learning journey',
            'login_with_google': 'Sign in with Google',
            'signup_with_google': 'Sign up with Google',
            'or': 'or',
            'email_address': 'Email address',
            'password': 'Password',
            'confirm_password': 'Confirm password',
            'remember_me': 'Remember me',
            'forgot_password': 'Forgot password?',
            'sign_in': 'Sign in',
            'sign_up': 'Sign up',
            'dont_have_account': "Don't have an account?",
            'already_have_account': 'Already have an account?',
            'email_verification_notice': 'We will send you a verification email to activate your account.',
            'logout': 'Logout',
            'profile': 'Profile',
            # Decks
            'my_decks': 'My Decks',
            'back_to_all_decks': 'Back to all decks',
            # Statistics
            'statistics_title': 'Statistics',
            'total_decks': 'Total Decks',
            'average_cards_per_deck': 'Average Cards per Deck',
            'cards_per_deck': 'Cards per Deck',
            'no_decks_message': 'You have no decks yet.',
            # Study labels
            'start_study': 'Start Study',
            'select_decks': 'Select decks to study',
            'no_cards_due': 'No cards due for review today.',
            'grade_again': 'Again',
            'grade_hard': 'Hard',
            'grade_good': 'Good',
            'grade_easy': 'Easy',
            'show_answer': 'Show Answer',
            'mode_multiple_choice': 'Multiple Choice',
            'mode_type_answer': 'Type Answer',
            'select_mode': 'Select study mode',
            'check': 'Check',
            'correct': 'Correct!',
            'incorrect': 'Incorrect',
            'answer_placeholder': 'Type your answer...',
            'study_complete_title': 'Great job!',
            'study_complete_text': 'You have reviewed all due cards.',
            'next_card': 'Next Card ‚Üí',
            'vietnamese_meaning': 'Vietnamese meaning',
            'dictation_placeholder': 'Listen and type the English word...',
            'select_at_least_one_deck': 'Please select at least one deck',
            # Add flashcard form
            'select_deck': 'Select deck:',
            'please_select_deck': '-- Please select a deck --',
            'create_new_deck': '-- Create new deck --',
            'term_label': 'TERM',
            'phonetic_label': 'PHONETIC',
            'english_definition_label': 'DEFINITION (ENGLISH)',
            'vietnamese_definition_label': 'DEFINITION (VIETNAMESE)',
            'term_placeholder': 'e.g., \'serendipity\'',
            'phonetic_placeholder': '/Àåser.…ônÀàd…™p.…ô.tÃ¨i/',
            'definition_placeholder': 'A concise and clear definition...',
            'vietnamese_placeholder': 'Vietnamese translation...',
            'upload_image': 'Upload image',
            'add_new_card': '‚ûï Add new card',
            'save_all_flashcards': 'üíæ Save all Flashcards',
            'drag_to_move': 'Drag to move card',
            'delete_card': 'Delete card',
            'part_of_speech': 'part of speech',
            'listen': 'Listen',

            # Quick Add Words section
            'quick_add_multiple_words': 'Quick Add Multiple Words',
            'quick_add_placeholder': 'Enter multiple words separated by | (pipe character). Example: assistant|cry|usual|file|ban|ice|column|currently|prepare|acceptable',
            'quick_add_info': 'Separate words with | (pipe) character. Each word will be automatically processed for spelling, definitions, and duplicates.',
            'generate_cards': 'Generate Cards',
            'processing_words': 'Processing words...',
            'processing_word_individual': 'Processing "{word}" ({current}/{total})...',

            # SweetAlert messages
            'create_new_deck_title': 'Create New Deck',
            'deck_name_label': 'Deck Name',
            'deck_name_placeholder': 'Example: Day 1, IELTS Topic: Work...',
            'deck_name_required': 'You need to enter a name for the deck!',
            'cancel': 'Cancel',
            'created': 'Created!',
            'deck_created_success': 'Deck "{deck_name}" has been created successfully.',
            'cannot_create_deck': 'Cannot create deck',
            'unknown_error': 'Unknown error',

            # Duplicate warnings
            'duplicate_word_detected': 'Duplicate Word Detected',
            'word_already_exists': 'The word "{word}" already exists in your vocabulary.',
            'use_different_word': 'Please use a different word or modify the existing one.',

            # Processing and validation messages
            'no_words_found': 'No Words Found',
            'enter_words_pipe': 'Please enter some words separated by | (pipe) character.',
            'no_deck_selected': 'No Deck Selected',
            'select_deck_before_adding': 'Please select a deck before adding words.',
            'cannot_delete_only_card': 'Cannot delete the only card!',
            'translating': 'Translating...',
            'translation_not_available': 'Translation not available.',
            'translation_error': 'Translation error.',

            # Quick Add results
            'quick_add_results': 'Quick Add Results',
            'words_added_successfully': 'Successfully added {count} words: {words}',
            'duplicate_words_skipped': 'Skipped {count} duplicate words: {words}',
            'words_with_errors': 'Failed to process {count} words: {words}',
            'no_words_processed': 'No words were processed. Please check your input.',

            # Flashcard save success messages
            'saved_successfully': 'Saved successfully!',
            'words_added_to_collection': 'Words have been added to the collection: {words}',

            'correct_answer': 'Correct answer',
            # Console messages
            'console_welcome': 'üéì LearnEnglish App',
            'console_subtitle': 'Welcome to the developer console!',
            'console_built_with': 'Built with Django + Tailwind CSS + JavaScript ‚ù§Ô∏è',
            # Deck list
            'cards_text': 'cards',
            'no_decks_yet': 'You don\'t have any decks yet.',
            'get_started_by': 'Get started by',
            'adding_flashcards': 'adding some new flashcards',
            # Study
            'search_cambridge': 'Search on Cambridge Dictionary',
            'continue_button': 'Continue',
            'no_decks_selected': 'No decks selected',
            'back_to_login': 'Back to Login',
            'no_decks_available': 'No decks available',
            # Edit functionality
            'edit_card': 'Edit Card',
            'save_changes': 'Save Changes',
            'cancel_edit': 'Cancel',
            'edit_mode': 'Edit Mode',
            'card_updated_successfully': 'Card updated successfully!',
            'error_updating_card': 'Error updating card',
            'confirm_cancel_edit': 'Are you sure you want to cancel? Unsaved changes will be lost.',
            'this_deck_empty': 'This deck is empty.',
            'add_some_cards': 'Add some cards!',
            # Audio status indicators
            'has_audio': 'Has Audio',
            'no_audio': 'No Audio',
            'audio_available': 'Audio Available',
            'audio_missing': 'Audio Missing',
            'add_audio_url': 'Add audio URL to enable pronunciation',
            'filter_by_audio': 'Filter by Audio Status',
            'show_all_cards': 'Show All Cards',
            'show_cards_with_audio': 'Cards with Audio',
            'show_cards_without_audio': 'Cards without Audio',
            # Deck editing
            'edit_deck_name': 'Edit Deck Name',
            'deck_name': 'Deck Name',
            'save_deck_name': 'Save Name',
            'cancel_deck_edit': 'Cancel',
            'deck_name_updated': 'Deck name updated successfully!',
            'error_updating_deck': 'Error updating deck name',
            'deck_name_required': 'Deck name is required',
            # Audio fetching
            'fetch_missing_audio': 'Fetch Missing Audio',
            'fetching_audio': 'Fetching audio...',
            'audio_fetched_successfully': 'Audio fetched successfully!',
            'no_audio_found': 'No audio found for some words',
            'audio_fetch_error': 'Error fetching audio',
            'audio_fetch_complete': 'Audio fetch complete',
            'cards_updated': 'cards updated',
            'auto_fetch_audio': 'Auto-fetch audio for new cards',

            # Enhanced Audio Fetching
            'enhanced_audio_selection': 'Enhanced Audio Selection',
            'select_audio_pronunciation': 'Select Audio Pronunciation for:',
            'available_audio_options': 'Available Audio Options',
            'current_audio': 'Current Audio',
            'no_current_audio': 'No current audio',
            'preview': 'Preview',
            'us_pronunciation': 'US pronunciation',
            'uk_pronunciation': 'UK pronunciation',
            'primary_pronunciation': 'Primary pronunciation',
            'alternative_pronunciation': 'Alternative pronunciation',
            'ready': 'Ready',
            'playing': 'Playing',
            'keep_current': 'Keep Current',
            'confirm_selection': 'Confirm Selection',
            'no_audio_options_found': 'No audio options found',
            'try_checking_spelling': 'Try checking the word spelling or search manually on Cambridge Dictionary',
            'fetching_audio_options': 'Fetching audio options...',
            'audio_selection_updated': 'Audio pronunciation updated successfully!',
            'error_updating_audio': 'Error updating audio selection',
            'please_select_audio': 'Please select an audio option',
            'enhanced_audio_fetch': 'Enhanced Audio Fetch',
            'get_multiple_pronunciations': 'Get Multiple Pronunciations',

            # Study Mode Selection
            'study_mode': 'Study Mode',
            'normal_study_by_decks': 'Normal Study (by Decks)',
            'study_random_words': 'Study Random Words',
            'number_of_words': 'Number of Words',
            'available_words': 'Available Words',
            'select_decks': 'Select Decks',
            'no_decks_selected': 'No decks selected',
            'no_decks_available': 'No decks available',
            'start_study': 'Start Study',
            'correct': 'Correct',
            'incorrect': 'Incorrect',
            'check': 'Check',
            'answer_placeholder': 'Enter your answer...',
            'grade_again': 'Again',
            'grade_hard': 'Hard',
            'grade_good': 'Good',
            'grade_easy': 'Easy',
            'view_in_cambridge': 'View in Cambridge Dictionary',
            'no_cards_due': 'No cards due',
            'back_to_selection': 'Back to Selection',
            # Audio and study interface
            'play_audio': 'Play Audio',
            'listen_and_type': 'Listen and type what you hear',
            'type_what_you_hear': 'Type what you hear...',
            'correct_answer': 'Correct!',
            'incorrect_answer': 'Incorrect',
            'replay_audio': 'Replay',
            'english_label': 'English:',
            'vietnamese_label': 'Vietnamese:',

            # Deck detail interface
            'word_required': 'Word is required',
            'definition_required': 'At least one definition is required',
            'saving': 'Saving...',
            'previous_deck': 'Previous deck',
            'next_deck': 'Next deck',
            'card_updated_successfully': 'Card updated successfully!',
            'error_updating_card': 'Error updating card',
            'confirm_cancel_edit': 'Are you sure you want to cancel? Unsaved changes will be lost.',
            'deck_name_required': 'Deck name is required',
            'deck_name_updated': 'Deck name updated successfully!',
            'error_updating_deck': 'Error updating deck name',
            'save_deck_name': 'Save Name',
            'fetching_audio': 'Fetching audio...',
            'audio_fetched_successfully': 'Audio fetched successfully!',
            'cards_updated': 'cards updated',
            'no_audio_found': 'No audio found for some words',
            'audio_fetch_error': 'Error fetching audio',
            'audio_fetch_complete': 'Audio fetch complete',
            'found_label': 'Found:',
            'method_not_allowed': 'Method not allowed. Please refresh the page and try again.',
            'permission_denied': 'Permission denied. Please refresh the page and try again.',
            'card_not_found': 'Card not found. Please refresh the page and try again.',
            'server_response_error': 'Server response error. Please try again.',
            'no_definitions_available': 'No definitions available',
            'audio_url_label': 'Audio URL',
            'audio_url_placeholder': 'https://example.com/audio.mp3',
            'definitions_label': 'Definitions',
            'signed_in_as': 'Signed in as',
            'select_deck_alert': 'Please select at least one deck to study.',
            'no_decks_selected': 'No decks selected',
            'words_unit': 'words',
            'deck_study_description': 'Study specific flashcard decks',
            'random_study_description': 'Study random words from all decks',
            'sound_feedback': 'Sound Feedback',
            'review_incorrect_words': 'Review Incorrect Words',
            'review_study_description': 'Study words you previously answered incorrectly',
            'incorrect_words_count': 'incorrect words to review',
            'review_mode_description': 'Practice words you answered incorrectly in their original question format until you master them.',
            'start_review': 'Start Review',
            'multiple_choice': 'Multiple Choice',
            'input_mode': 'Input Mode',
            'dictation_mode': 'Dictation Mode',
            'review_completed_title': 'Congratulations!',
            'review_completed_message': 'You have successfully reviewed all incorrect words!',
            'continue_studying': 'Continue Studying',
        },
        'vi': {
            'learn_english': 'H·ªçc Ti·∫øng Anh',
            'home': 'Trang ch·ªß',
            'flashcards': 'Th·∫ª t·ª´ v·ª±ng',
            'add_word': 'Th√™m t·ª´',
            'study': 'H·ªçc t·∫≠p',
            'statistics': 'Th·ªëng k√™',
            'dashboard': 'B·∫£ng ƒëi·ªÅu khi·ªÉn',
            'welcome_message': 'Ch√†o m·ª´ng ƒë·∫øn v·ªõi LearnEnglish',
            'platform_description': 'N·ªÅn t·∫£ng h·ªçc t·ª´ v·ª±ng c√° nh√¢n c·ªßa b·∫°n',
            'total_cards': 'T·ªïng s·ªë th·∫ª',
            'recent_cards': 'Th·∫ª g·∫ßn ƒë√¢y',
            'progress': 'Ti·∫øn ƒë·ªô',
            'add_new_words': 'Th√™m t·ª´ m·ªõi',
            'study_cards': 'H·ªçc th·∫ª t·ª´',
            'add_flashcard': 'Th√™m Flashcard',
            'add_new_flashcard': 'Th√™m Flashcard M·ªõi',
            'add_vocabulary_description': 'Th√™m t·ª´ v·ª±ng m·ªõi v√†o b·ªô s∆∞u t·∫≠p c·ªßa b·∫°n',
            'my_flashcards': 'Th·∫ª t·ª´ v·ª±ng c·ªßa t√¥i',
            'vocabulary_collection': 'B·ªô s∆∞u t·∫≠p t·ª´ v·ª±ng c·ªßa b·∫°n',
            # Authentication texts
            'login_title': 'ƒêƒÉng nh·∫≠p',
            'signup_title': 'ƒêƒÉng k√Ω',
            'welcome_back': 'Ch√†o m·ª´ng tr·ªü l·∫°i!',
            'login_subtitle': 'ƒêƒÉng nh·∫≠p v√†o t√†i kho·∫£n c·ªßa b·∫°n',
            'create_account': 'T·∫°o t√†i kho·∫£n',
            'signup_subtitle': 'B·∫Øt ƒë·∫ßu h√†nh tr√¨nh h·ªçc t·ª´ v·ª±ng',
            'login_with_google': 'ƒêƒÉng nh·∫≠p v·ªõi Google',
            'signup_with_google': 'ƒêƒÉng k√Ω v·ªõi Google',
            'or': 'ho·∫∑c',
            'email_address': 'ƒê·ªãa ch·ªâ email',
            'password': 'M·∫≠t kh·∫©u',
            'confirm_password': 'X√°c nh·∫≠n m·∫≠t kh·∫©u',
            'remember_me': 'Ghi nh·ªõ ƒëƒÉng nh·∫≠p',
            'forgot_password': 'Qu√™n m·∫≠t kh·∫©u?',
            'sign_in': 'ƒêƒÉng nh·∫≠p',
            'sign_up': 'ƒêƒÉng k√Ω',
            'dont_have_account': 'Ch∆∞a c√≥ t√†i kho·∫£n?',
            'already_have_account': 'ƒê√£ c√≥ t√†i kho·∫£n?',
            'email_verification_notice': 'Ch√∫ng t√¥i s·∫Ω g·ª≠i email x√°c th·ª±c ƒë·ªÉ k√≠ch ho·∫°t t√†i kho·∫£n c·ªßa b·∫°n.',
            'logout': 'ƒêƒÉng xu·∫•t',
            'profile': 'H·ªì s∆°',
            # Decks
            'my_decks': 'C√°c b·ªô th·∫ª',
            'back_to_all_decks': 'Quay l·∫°i t·∫•t c·∫£ b·ªô th·∫ª',
            # Statistics
            'statistics_title': 'Th·ªëng k√™',
            'total_decks': 'T·ªïng s·ªë b·ªô th·∫ª',
            'average_cards_per_deck': 'S·ªë th·∫ª trung b√¨nh m·ªói b·ªô',
            'cards_per_deck': 'S·ªë th·∫ª trong m·ªói b·ªô',
            'no_decks_message': 'B·∫°n ch∆∞a c√≥ b·ªô th·∫ª n√†o.',
            # Study labels
            'start_study': 'B·∫Øt ƒë·∫ßu √¥n',
            'select_decks': 'Ch·ªçn b·ªô th·∫ª ƒë·ªÉ √¥n',
            'no_cards_due': 'H√¥m nay kh√¥ng c√≥ th·∫ª c·∫ßn √¥n.',
            'grade_again': 'L√†m l·∫°i',
            'grade_hard': 'Kh√≥',
            'grade_good': 'T·ªët',
            'grade_easy': 'D·ªÖ',
            'show_answer': 'Hi·ªán ƒë√°p √°n',
            'mode_multiple_choice': 'Tr·∫Øc nghi·ªám',
            'mode_type_answer': 'G√µ ƒë√°p √°n',
            'select_mode': 'Ch·ªçn ch·∫ø ƒë·ªô h·ªçc',
            'check': 'Ki·ªÉm tra',
            'correct': 'Ch√≠nh x√°c!',
            'incorrect': 'Ch∆∞a ƒë√∫ng',
            'answer_placeholder': 'Nh·∫≠p ƒë√°p √°n...',
            'study_complete_title': 'Ho√†n th√†nh!',
            'study_complete_text': 'B·∫°n ƒë√£ √¥n xong t·∫•t c·∫£ th·∫ª c·∫ßn √¥n.',
            'next_card': 'Th·∫ª ti·∫øp theo ‚Üí',
            'vietnamese_meaning': 'Nghƒ©a ti·∫øng Vi·ªát',
            'dictation_placeholder': 'Nghe v√† nh·∫≠p t·ª´ ti·∫øng Anh...',
            'select_at_least_one_deck': 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt b·ªô th·∫ª',
            # Add flashcard form
            'select_deck': 'Ch·ªçn b·ªô th·∫ª:',
            'please_select_deck': '-- Vui l√≤ng ch·ªçn m·ªôt b·ªô th·∫ª --',
            'create_new_deck': '-- T·∫°o b·ªô th·∫ª m·ªõi --',
            'term_label': 'THU·∫¨T NG·ªÆ',
            'phonetic_label': 'PH√ÅT √ÇM',
            'english_definition_label': 'ƒê·ªäNH NGHƒ®A (ENGLISH)',
            'vietnamese_definition_label': 'ƒê·ªäNH NGHƒ®A (VIETNAMESE)',
            'term_placeholder': 'v√≠ d·ª•: \'serendipity\'',
            'phonetic_placeholder': '/Àåser.…ônÀàd…™p.…ô.tÃ¨i/',
            'definition_placeholder': 'ƒê·ªãnh nghƒ©a r√µ r√†ng v√† ng·∫Øn g·ªçn...',
            'vietnamese_placeholder': 'B·∫£n d·ªãch ti·∫øng Vi·ªát...',
            'upload_image': 'T·∫£i ·∫£nh l√™n',
            'add_new_card': '‚ûï Th√™m th·∫ª m·ªõi',
            'save_all_flashcards': 'üíæ L∆∞u t·∫•t c·∫£ Flashcards',
            'drag_to_move': 'K√©o ƒë·ªÉ di chuy·ªÉn th·∫ª',
            'delete_card': 'X√≥a th·∫ª',
            'part_of_speech': 't·ª´ lo·∫°i',
            'listen': 'Nghe',

            # Quick Add Words section
            'quick_add_multiple_words': 'Th√™m nhanh nhi·ªÅu t·ª´',
            'quick_add_placeholder': 'Nh·∫≠p nhi·ªÅu t·ª´ c√°ch nhau b·∫±ng k√Ω t·ª± | (pipe). V√≠ d·ª•: assistant|cry|usual|file|ban|ice|column|currently|prepare|acceptable',
            'quick_add_info': 'Ph√¢n t√°ch c√°c t·ª´ b·∫±ng k√Ω t·ª± | (pipe). M·ªói t·ª´ s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông x·ª≠ l√Ω v·ªÅ ch√≠nh t·∫£, ƒë·ªãnh nghƒ©a v√† tr√πng l·∫∑p.',
            'generate_cards': 'T·∫°o th·∫ª',
            'processing_words': 'ƒêang x·ª≠ l√Ω t·ª´...',
            'processing_word_individual': 'ƒêang x·ª≠ l√Ω "{word}" ({current}/{total})...',

            # SweetAlert messages
            'create_new_deck_title': 'T·∫°o b·ªô th·∫ª m·ªõi',
            'deck_name_label': 'T√™n b·ªô th·∫ª',
            'deck_name_placeholder': 'V√≠ d·ª•: Ng√†y 1, IELTS Topic: Work...',
            'deck_name_required': 'B·∫°n c·∫ßn nh·∫≠p t√™n cho b·ªô th·∫ª!',
            'cancel': 'H·ªßy',
            'created': 'ƒê√£ t·∫°o!',
            'deck_created_success': 'B·ªô th·∫ª "{deck_name}" ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng.',
            'cannot_create_deck': 'Kh√¥ng th·ªÉ t·∫°o b·ªô th·∫ª',
            'unknown_error': 'L·ªói kh√¥ng x√°c ƒë·ªãnh',

            # Duplicate warnings
            'duplicate_word_detected': 'Ph√°t hi·ªán t·ª´ tr√πng l·∫∑p',
            'word_already_exists': 'T·ª´ "{word}" ƒë√£ t·ªìn t·∫°i trong t·ª´ v·ª±ng c·ªßa b·∫°n.',
            'use_different_word': 'Vui l√≤ng s·ª≠ d·ª•ng t·ª´ kh√°c ho·∫∑c ch·ªânh s·ª≠a t·ª´ hi·ªán c√≥.',

            # Processing and validation messages
            'no_words_found': 'Kh√¥ng t√¨m th·∫•y t·ª´ n√†o',
            'enter_words_pipe': 'Vui l√≤ng nh·∫≠p m·ªôt s·ªë t·ª´ c√°ch nhau b·∫±ng k√Ω t·ª± | (pipe).',
            'no_deck_selected': 'Ch∆∞a ch·ªçn b·ªô th·∫ª',
            'select_deck_before_adding': 'Vui l√≤ng ch·ªçn m·ªôt b·ªô th·∫ª tr∆∞·ªõc khi th√™m t·ª´.',
            'cannot_delete_only_card': 'Kh√¥ng th·ªÉ x√≥a th·∫ª duy nh·∫•t!',
            'translating': 'ƒêang d·ªãch...',
            'translation_not_available': 'B·∫£n d·ªãch kh√¥ng c√≥ s·∫µn.',
            'translation_error': 'L·ªói d·ªãch thu·∫≠t.',

            # Quick Add results
            'quick_add_results': 'K·∫øt qu·∫£ th√™m nhanh',
            'words_added_successfully': 'ƒê√£ th√™m th√†nh c√¥ng {count} t·ª´: {words}',
            'duplicate_words_skipped': 'ƒê√£ b·ªè qua {count} t·ª´ tr√πng l·∫∑p: {words}',
            'words_with_errors': 'Kh√¥ng th·ªÉ x·ª≠ l√Ω {count} t·ª´: {words}',
            'no_words_processed': 'Kh√¥ng c√≥ t·ª´ n√†o ƒë∆∞·ª£c x·ª≠ l√Ω. Vui l√≤ng ki·ªÉm tra ƒë·∫ßu v√†o.',

            # Flashcard save success messages
            'saved_successfully': 'ƒê√£ l∆∞u th√†nh c√¥ng!',
            'words_added_to_collection': 'C√°c t·ª´ ƒë√£ ƒë∆∞·ª£c th√™m v√†o b·ªô s∆∞u t·∫≠p: {words}',

            'correct_answer': 'ƒê√°p √°n',
            # Console messages
            'console_welcome': 'üéì ·ª®ng d·ª•ng LearnEnglish',
            'console_subtitle': 'Ch√†o m·ª´ng ƒë·∫øn v·ªõi console ph√°t tri·ªÉn!',
            'console_built_with': 'ƒê∆∞·ª£c x√¢y d·ª±ng v·ªõi Django + Tailwind CSS + JavaScript ‚ù§Ô∏è',
            # Deck list
            'cards_text': 'th·∫ª',
            'no_decks_yet': 'B·∫°n ch∆∞a c√≥ b·ªô th·∫ª n√†o.',
            'get_started_by': 'B·∫Øt ƒë·∫ßu b·∫±ng c√°ch',
            'adding_flashcards': 'th√™m m·ªôt s·ªë flashcard m·ªõi',
            # Study
            'search_cambridge': 'T√¨m ki·∫øm tr√™n Cambridge Dictionary',
            'continue_button': 'Ti·∫øp t·ª•c',
            'no_decks_selected': 'Ch∆∞a ch·ªçn b·ªô th·∫ª n√†o',
            'back_to_login': 'Quay l·∫°i ƒêƒÉng nh·∫≠p',
            'no_decks_available': 'Kh√¥ng c√≥ b·ªô th·∫ª n√†o',
            # Edit functionality
            'edit_card': 'Ch·ªânh s·ª≠a th·∫ª',
            'save_changes': 'L∆∞u thay ƒë·ªïi',
            'cancel_edit': 'H·ªßy',
            'edit_mode': 'Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a',
            'card_updated_successfully': 'C·∫≠p nh·∫≠t th·∫ª th√†nh c√¥ng!',
            'error_updating_card': 'L·ªói khi c·∫≠p nh·∫≠t th·∫ª',
            'confirm_cancel_edit': 'B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy? C√°c thay ƒë·ªïi ch∆∞a l∆∞u s·∫Ω b·ªã m·∫•t.',
            'this_deck_empty': 'B·ªô th·∫ª n√†y tr·ªëng.',
            'add_some_cards': 'Th√™m m·ªôt s·ªë th·∫ª!',
            # Audio status indicators
            'has_audio': 'C√≥ √¢m thanh',
            'no_audio': 'Kh√¥ng c√≥ √¢m thanh',
            'audio_available': 'C√≥ √¢m thanh',
            'audio_missing': 'Thi·∫øu √¢m thanh',
            'add_audio_url': 'Th√™m URL √¢m thanh ƒë·ªÉ b·∫≠t ph√°t √¢m',
            'filter_by_audio': 'L·ªçc theo tr·∫°ng th√°i √¢m thanh',
            'show_all_cards': 'Hi·ªÉn th·ªã t·∫•t c·∫£ th·∫ª',
            'show_cards_with_audio': 'Th·∫ª c√≥ √¢m thanh',
            'show_cards_without_audio': 'Th·∫ª kh√¥ng c√≥ √¢m thanh',
            # Deck editing
            'edit_deck_name': 'Ch·ªânh s·ª≠a t√™n b·ªô th·∫ª',
            'deck_name': 'T√™n b·ªô th·∫ª',
            'save_deck_name': 'L∆∞u t√™n',
            'cancel_deck_edit': 'H·ªßy',
            'deck_name_updated': 'C·∫≠p nh·∫≠t t√™n b·ªô th·∫ª th√†nh c√¥ng!',
            'error_updating_deck': 'L·ªói khi c·∫≠p nh·∫≠t t√™n b·ªô th·∫ª',
            'deck_name_required': 'T√™n b·ªô th·∫ª l√† b·∫Øt bu·ªôc',
            # Audio fetching
            'fetch_missing_audio': 'L·∫•y √¢m thanh thi·∫øu',
            'fetching_audio': 'ƒêang l·∫•y √¢m thanh...',
            'audio_fetched_successfully': 'L·∫•y √¢m thanh th√†nh c√¥ng!',
            'no_audio_found': 'Kh√¥ng t√¨m th·∫•y √¢m thanh cho m·ªôt s·ªë t·ª´',
            'audio_fetch_error': 'L·ªói khi l·∫•y √¢m thanh',
            'audio_fetch_complete': 'Ho√†n th√†nh l·∫•y √¢m thanh',
            'cards_updated': 'th·∫ª ƒë√£ c·∫≠p nh·∫≠t',
            'auto_fetch_audio': 'T·ª± ƒë·ªông l·∫•y √¢m thanh cho th·∫ª m·ªõi',

            # Enhanced Audio Fetching
            'enhanced_audio_selection': 'Ch·ªçn √¢m thanh n√¢ng cao',
            'select_audio_pronunciation': 'Ch·ªçn c√°ch ph√°t √¢m cho:',
            'available_audio_options': 'T√πy ch·ªçn √¢m thanh c√≥ s·∫µn',
            'current_audio': '√Çm thanh hi·ªán t·∫°i',
            'no_current_audio': 'Kh√¥ng c√≥ √¢m thanh hi·ªán t·∫°i',
            'preview': 'Nghe th·ª≠',
            'us_pronunciation': 'Ph√°t √¢m M·ªπ',
            'uk_pronunciation': 'Ph√°t √¢m Anh',
            'primary_pronunciation': 'Ph√°t √¢m ch√≠nh',
            'alternative_pronunciation': 'Ph√°t √¢m thay th·∫ø',
            'ready': 'S·∫µn s√†ng',
            'playing': 'ƒêang ph√°t',
            'keep_current': 'Gi·ªØ nguy√™n',
            'confirm_selection': 'X√°c nh·∫≠n l·ª±a ch·ªçn',
            'no_audio_options_found': 'Kh√¥ng t√¨m th·∫•y t√πy ch·ªçn √¢m thanh',
            'try_checking_spelling': 'Th·ª≠ ki·ªÉm tra ch√≠nh t·∫£ ho·∫∑c t√¨m ki·∫øm th·ªß c√¥ng tr√™n Cambridge Dictionary',
            'fetching_audio_options': 'ƒêang t√¨m t√πy ch·ªçn √¢m thanh...',
            'audio_selection_updated': 'C·∫≠p nh·∫≠t c√°ch ph√°t √¢m th√†nh c√¥ng!',
            'error_updating_audio': 'L·ªói khi c·∫≠p nh·∫≠t l·ª±a ch·ªçn √¢m thanh',
            'please_select_audio': 'Vui l√≤ng ch·ªçn m·ªôt t√πy ch·ªçn √¢m thanh',
            'enhanced_audio_fetch': 'L·∫•y √¢m thanh n√¢ng cao',
            'get_multiple_pronunciations': 'L·∫•y nhi·ªÅu c√°ch ph√°t √¢m',

            # Study Mode Selection
            'study_mode': 'Ch·∫ø ƒë·ªô h·ªçc t·∫≠p',
            'normal_study_by_decks': 'H·ªçc b√¨nh th∆∞·ªùng (theo b·ªô th·∫ª)',
            'study_random_words': 'H·ªçc t·ª´ ng·∫´u nhi√™n',
            'number_of_words': 'S·ªë l∆∞·ª£ng t·ª´',
            'available_words': 'T·ª´ c√≥ s·∫µn',
            'select_decks': 'Ch·ªçn b·ªô th·∫ª',
            'no_decks_selected': 'Ch∆∞a ch·ªçn b·ªô th·∫ª n√†o',
            'no_decks_available': 'Kh√¥ng c√≥ b·ªô th·∫ª n√†o',
            'start_study': 'B·∫Øt ƒë·∫ßu h·ªçc',
            'correct': 'ƒê√∫ng',
            'incorrect': 'Sai',
            'check': 'Ki·ªÉm tra',
            'answer_placeholder': 'Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n...',
            'grade_again': 'L·∫°i',
            'grade_hard': 'Kh√≥',
            'grade_good': 'T·ªët',
            'grade_easy': 'D·ªÖ',
            'view_in_cambridge': 'Xem trong Cambridge Dictionary',
            'no_cards_due': 'Kh√¥ng c√≥ th·∫ª n√†o c·∫ßn h·ªçc',
            'back_to_selection': 'Quay l·∫°i l·ª±a ch·ªçn',
            # Audio and study interface
            'play_audio': 'Ph√°t √¢m',
            'listen_and_type': 'Nghe v√† vi·∫øt nh·ªØng g√¨ b·∫°n nghe ƒë∆∞·ª£c',
            'type_what_you_hear': 'Vi·∫øt nh·ªØng g√¨ b·∫°n nghe ƒë∆∞·ª£c...',
            'correct_answer': 'ƒê√∫ng!',
            'incorrect_answer': 'Sai',
            'replay_audio': 'Nghe l·∫°i',
            'english_label': 'Ti·∫øng Anh:',
            'vietnamese_label': 'Ti·∫øng Vi·ªát:',

            # Deck detail interface
            'word_required': 'T·ª´ v·ª±ng l√† b·∫Øt bu·ªôc',
            'definition_required': 'C·∫ßn √≠t nh·∫•t m·ªôt ƒë·ªãnh nghƒ©a',
            'saving': 'ƒêang l∆∞u...',
            'previous_deck': 'B·ªô th·∫ª tr∆∞·ªõc',
            'next_deck': 'B·ªô th·∫ª ti·∫øp theo',
            'card_updated_successfully': 'C·∫≠p nh·∫≠t th·∫ª th√†nh c√¥ng!',
            'error_updating_card': 'L·ªói khi c·∫≠p nh·∫≠t th·∫ª',
            'confirm_cancel_edit': 'B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy? C√°c thay ƒë·ªïi ch∆∞a l∆∞u s·∫Ω b·ªã m·∫•t.',
            'deck_name_required': 'T√™n b·ªô th·∫ª l√† b·∫Øt bu·ªôc',
            'deck_name_updated': 'C·∫≠p nh·∫≠t t√™n b·ªô th·∫ª th√†nh c√¥ng!',
            'error_updating_deck': 'L·ªói khi c·∫≠p nh·∫≠t t√™n b·ªô th·∫ª',
            'save_deck_name': 'L∆∞u T√™n',
            'fetching_audio': 'ƒêang t·∫£i √¢m thanh...',
            'audio_fetched_successfully': 'T·∫£i √¢m thanh th√†nh c√¥ng!',
            'cards_updated': 'th·∫ª ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t',
            'no_audio_found': 'Kh√¥ng t√¨m th·∫•y √¢m thanh cho m·ªôt s·ªë t·ª´',
            'audio_fetch_error': 'L·ªói khi t·∫£i √¢m thanh',
            'audio_fetch_complete': 'Ho√†n th√†nh t·∫£i √¢m thanh',
            'found_label': 'T√¨m th·∫•y:',
            'method_not_allowed': 'Ph∆∞∆°ng th·ª©c kh√¥ng ƒë∆∞·ª£c ph√©p. Vui l√≤ng l√†m m·ªõi trang v√† th·ª≠ l·∫°i.',
            'permission_denied': 'Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p. Vui l√≤ng l√†m m·ªõi trang v√† th·ª≠ l·∫°i.',
            'card_not_found': 'Kh√¥ng t√¨m th·∫•y th·∫ª. Vui l√≤ng l√†m m·ªõi trang v√† th·ª≠ l·∫°i.',
            'server_response_error': 'L·ªói ph·∫£n h·ªìi t·ª´ m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.',
            'no_definitions_available': 'Kh√¥ng c√≥ ƒë·ªãnh nghƒ©a n√†o',
            'audio_url_label': 'URL √Çm thanh',
            'audio_url_placeholder': 'https://example.com/audio.mp3',
            'definitions_label': 'ƒê·ªãnh nghƒ©a',
            'signed_in_as': 'ƒê√£ ƒëƒÉng nh·∫≠p v·ªõi t∆∞ c√°ch',
            'select_deck_alert': 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt b·ªô th·∫ª ƒë·ªÉ h·ªçc.',
            'no_decks_selected': 'Ch∆∞a ch·ªçn b·ªô th·∫ª n√†o',
            'words_unit': 't·ª´',
            'deck_study_description': 'H·ªçc theo t·ª´ng b·ªô th·∫ª c·ª• th·ªÉ',
            'random_study_description': 'H·ªçc t·ª´ ng·∫´u nhi√™n t·ª´ t·∫•t c·∫£ b·ªô th·∫ª',
            'sound_feedback': '√Çm thanh ph·∫£n h·ªìi',
            'review_incorrect_words': '√în l·∫°i t·ª´ ƒë√£ sai',
            'review_study_description': 'H·ªçc l·∫°i nh·ªØng t·ª´ b·∫°n ƒë√£ tr·∫£ l·ªùi sai tr∆∞·ªõc ƒë√¢y',
            'incorrect_words_count': 't·ª´ sai c·∫ßn √¥n l·∫°i',
            'review_mode_description': 'Luy·ªán t·∫≠p nh·ªØng t·ª´ b·∫°n ƒë√£ tr·∫£ l·ªùi sai theo ƒë·ªãnh d·∫°ng c√¢u h·ªèi g·ªëc cho ƒë·∫øn khi th√†nh th·∫°o.',
            'start_review': 'B·∫Øt ƒë·∫ßu √¥n t·∫≠p',
            'multiple_choice': 'Tr·∫Øc nghi·ªám',
            'input_mode': 'Nh·∫≠p t·ª´',
            'dictation_mode': 'Ch√≠nh t·∫£',
            'review_completed_title': 'Ch√∫c m·ª´ng!',
            'review_completed_message': 'B·∫°n ƒë√£ √¥n t·∫≠p th√†nh c√¥ng t·∫•t c·∫£ c√°c t·ª´ sai!',
            'continue_studying': 'Ti·∫øp t·ª•c h·ªçc',
        }
    }
    
    # Create a hybrid system that provides both legacy and Django i18n
    legacy_texts = legacy_translations.get(current_lang, legacy_translations['en'])

    # JavaScript translations using Django's gettext (fallback to English if translation fails)
    js_translations = {}
    try:
        js_translations = {
            'console_welcome': str(_("üéì LearnEnglish App")),
            'console_subtitle': str(_("Welcome to the developer console!")),
            'console_built_with': str(_("Built with Django + Tailwind CSS + JavaScript ‚ù§Ô∏è")),
            'home': str(_("Home")),
            'flashcards': str(_("Flashcards")),
            'add_word': str(_("Add Word")),
            'study': str(_("Study")),
            'statistics': str(_("Statistics")),
            'profile': str(_("Profile")),
            'logout': str(_("Logout")),
            'correct': str(_("Correct")),
            'incorrect': str(_("Incorrect")),
            'check': str(_("Check")),
            'saving': str(_("Saving...")),
            'loading': str(_("Loading...")),
            'error': str(_("Error")),
            'success': str(_("Success")),
        }
    except Exception:
        # Fallback to legacy translations if Django i18n fails
        js_translations = {
            'console_welcome': legacy_texts.get('console_welcome', 'üéì LearnEnglish App'),
            'console_subtitle': legacy_texts.get('console_subtitle', 'Welcome to the developer console!'),
            'console_built_with': legacy_texts.get('console_built_with', 'Built with Django + Tailwind CSS + JavaScript ‚ù§Ô∏è'),
            'home': legacy_texts.get('home', 'Home'),
            'flashcards': legacy_texts.get('flashcards', 'Flashcards'),
            'add_word': legacy_texts.get('add_word', 'Add Word'),
            'study': legacy_texts.get('study', 'Study'),
            'statistics': legacy_texts.get('statistics', 'Statistics'),
            'profile': legacy_texts.get('profile', 'Profile'),
            'logout': legacy_texts.get('logout', 'Logout'),
            'correct': legacy_texts.get('correct', 'Correct'),
            'incorrect': legacy_texts.get('incorrect', 'Incorrect'),
            'check': legacy_texts.get('check', 'Check'),
            'saving': legacy_texts.get('saving', 'Saving...'),
            'loading': legacy_texts.get('loading', 'Loading...'),
            'error': legacy_texts.get('error', 'Error'),
            'success': legacy_texts.get('success', 'Success'),
        }

    # For templates that haven't been migrated yet, provide manual_texts
    # For new templates, they should use {% trans %} tags directly
    return {
        'manual_texts': legacy_texts,  # Legacy support
        'current_language_code': current_lang,
        'js_translations_json': json.dumps(js_translations),  # JSON string for JavaScript
    }

def manual_translations(request):
    """
    DEPRECATED: Use i18n_compatible_translations instead.
    This function is kept for backward compatibility only.
    """
    return i18n_compatible_translations(request)